name: Python Deploy to prod

on:
  workflow_run:
    workflows: ["Python Deploy to test"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-python-${{ github.ref }}-${{ github.workflow }}-prod
  cancel-in-progress: false

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: prod
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f src/lambda-s3-lambda-trigger/requirements.txt ]; then pip install -r src/lambda-s3-lambda-trigger/requirements.txt; fi
      
      - name: Package Lambda function
        run: |
          cd src/lambda-s3-lambda-trigger
          zip -r ../../lambda-function-prod.zip .
      
      - name: Deploy Lambda function to prod
        run: |
          aws lambda update-function-code \
            --function-name s3-lambda-trigger-hello-world-prod \
            --zip-file fileb://lambda-function-prod.zip
      
      - name: Upload Lambda package to S3 (prod)
        run: |
          aws s3 cp lambda-function-prod.zip s3://${{ vars.DEPLOYMENT_BUCKET }}/lambda/prod/
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests in production environment..."
          # Add smoke test commands here
      
      - name: Verify deployment
        run: |
          aws lambda get-function --function-name s3-lambda-trigger-hello-world-prod
          echo "âœ… Lambda function deployed to production environment"
      
      - name: Notify deployment success
        run: |
          echo "ðŸš€ Production deployment completed successfully!"
          echo "Lambda function: s3-lambda-trigger-hello-world-prod"
          echo "Deployment time: $(date)"