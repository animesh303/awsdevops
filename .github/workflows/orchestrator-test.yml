name: Orchestrator Test

on:
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write
  actions: write

jobs:
  # Step 1: Python (no dependencies)
  python-test:
    runs-on: ubuntu-latest
    outputs:
      run-id: ${{ steps.find-run.outputs.run-id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find or trigger Python Test workflow
        uses: actions/github-script@v7
        id: find-run
        with:
          script: |
            // Find the most recent Python Test workflow run for this commit
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'python-test.yml',
              head_sha: context.sha,
              per_page: 1
            });

            if (runs.data.workflow_runs.length === 0) {
              // Trigger the workflow if it hasn't run yet
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'python-test.yml',
                ref: context.ref
              });
              // Wait a bit and find the run
              await new Promise(resolve => setTimeout(resolve, 5000));
              const newRuns = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'python-test.yml',
                head_sha: context.sha,
                per_page: 1
              });
              core.setOutput('run-id', newRuns.data.workflow_runs[0].id);
            } else {
              core.setOutput('run-id', runs.data.workflow_runs[0].id);
            }

      - name: Wait for Python Test to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.ref }}
          check-name: "Python Test"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success

      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          name: lambda-package-test
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.find-run.outputs.run-id }}
          path: ./lambda-package

  # Step 2: Terraform (depends on Python)
  terraform-test:
    runs-on: ubuntu-latest
    needs: [python-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Python artifacts from previous job
        uses: actions/download-artifact@v4
        with:
          name: lambda-package-test
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ needs.python-test.outputs.run-id }}
          path: ./lambda-package

      - name: Place artifacts for Terraform
        run: |
          mkdir -p ./iac/terraform
          cp ./lambda-package/lambda-package.zip ./iac/terraform/lambda_function.zip
          echo "✓ Lambda package placed for Terraform"

      - name: Find or trigger Terraform Test workflow
        uses: actions/github-script@v7
        id: find-run
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'terraform-test.yml',
              head_sha: context.sha,
              per_page: 1
            });

            if (runs.data.workflow_runs.length === 0) {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'terraform-test.yml',
                ref: context.ref
              });
              await new Promise(resolve => setTimeout(resolve, 5000));
              const newRuns = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'terraform-test.yml',
                head_sha: context.sha,
                per_page: 1
              });
              core.setOutput('run-id', newRuns.data.workflow_runs[0].id);
            } else {
              core.setOutput('run-id', runs.data.workflow_runs[0].id);
            }

      - name: Wait for Terraform Test to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.ref }}
          check-name: "Terraform Test"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success

  # Final: Deployment Summary
  deployment-summary:
    runs-on: ubuntu-latest
    needs: [python-test, terraform-test]
    if: always()
    steps:
      - name: Generate deployment summary
        run: |
          echo "## Test Environment Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python Test | ${{ needs.python-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Test | ${{ needs.terraform-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Order**: Python → Terraform" >> $GITHUB_STEP_SUMMARY
          echo "**Dependency**: Terraform depends on Python Lambda package" >> $GITHUB_STEP_SUMMARY