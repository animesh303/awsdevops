name: Terraform Deploy to test

on:
  workflow_run:
    workflows: ["Terraform Deploy to dev"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-terraform-${{ github.ref }}-${{ github.workflow }}-test
  cancel-in-progress: false

jobs:
  deploy-test:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: test
    steps:
      - uses: actions/checkout@v4

      - name: Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
            iac/terraform/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('iac/terraform/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.1

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Configure Terraform Cloud
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          cat > $HOME/.terraformrc << EOF
          credentials "app.terraform.io" {
            token = "$TFC_TOKEN"
          }
          EOF

      - name: Terraform Init
        working-directory: iac/terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: iac/terraform
        run: terraform plan

      - name: Terraform Apply
        working-directory: iac/terraform
        run: terraform apply -input=false -auto-approve

      - name: Get Website Bucket Name
        working-directory: iac/terraform
        run: |
          echo "BUCKET_NAME=$(terraform output -raw website_bucket_name)" >> $GITHUB_ENV
          echo "WEBSITE_URL=$(terraform output -raw website_url)" >> $GITHUB_ENV

      - name: Deploy Website Files to S3
        run: |
          echo "Deploying website files to S3 bucket: ${{ env.BUCKET_NAME }}"
          aws s3 sync src/website/ s3://${{ env.BUCKET_NAME }}/ --delete --cache-control "max-age=3600"
          echo "Website deployment completed"

      - name: Run Integration Tests
        run: |
          echo "Running integration tests against test environment..."
          sleep 10
          
          # Test website accessibility
          curl -f ${{ env.WEBSITE_URL }} || exit 1
          echo "‚úÖ Website accessibility test passed"
          
          # Test website content
          response=$(curl -s ${{ env.WEBSITE_URL }})
          if echo "$response" | grep -q "Hello World"; then
            echo "‚úÖ Website content test passed"
          else
            echo "‚ùå Website content test failed"
            exit 1
          fi
          
          # Test error page
          error_response=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.WEBSITE_URL }}/nonexistent)
          if [ "$error_response" = "404" ]; then
            echo "‚úÖ Error page test passed"
          else
            echo "‚ö†Ô∏è Error page test warning (got $error_response)"
          fi

      - name: Performance Test
        run: |
          echo "Running performance tests..."
          
          # Test response time
          response_time=$(curl -o /dev/null -s -w "%{time_total}" ${{ env.WEBSITE_URL }})
          echo "Response time: ${response_time}s"
          
          if (( $(echo "$response_time < 2.0" | bc -l) )); then
            echo "‚úÖ Performance test passed (${response_time}s < 2.0s)"
          else
            echo "‚ö†Ô∏è Performance test warning (${response_time}s >= 2.0s)"
          fi

      - name: Deployment Summary
        run: |
          echo "üöÄ Test Deployment Summary:"
          echo "Environment: test"
          echo "Website URL: ${{ env.WEBSITE_URL }}"
          echo "S3 Bucket: ${{ env.BUCKET_NAME }}"
          echo "Integration Tests: ‚úÖ Passed"
          echo "Performance Tests: ‚úÖ Passed"
          echo "Status: ‚úÖ Success"