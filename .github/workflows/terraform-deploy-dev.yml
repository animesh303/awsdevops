name: Terraform Deploy to dev

on:
  workflow_run:
    workflows: ["Terraform CI"]
    types: [completed]
    branches: [develop]

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-terraform-${{ github.ref }}-${{ github.workflow }}-dev
  cancel-in-progress: false

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: dev
    steps:
      - uses: actions/checkout@v4

      - name: Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
            iac/terraform/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('iac/terraform/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.1

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Configure Terraform Cloud
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          cat > $HOME/.terraformrc << EOF
          credentials "app.terraform.io" {
            token = "$TFC_TOKEN"
          }
          EOF

      - name: Terraform Init
        working-directory: iac/terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: iac/terraform
        run: terraform plan

      - name: Terraform Apply
        working-directory: iac/terraform
        run: terraform apply -input=false -auto-approve

      - name: Get Website Bucket Name
        working-directory: iac/terraform
        run: |
          echo "BUCKET_NAME=$(terraform output -raw website_bucket_name)" >> $GITHUB_ENV
          echo "WEBSITE_URL=$(terraform output -raw website_url)" >> $GITHUB_ENV

      - name: Deploy Website Files to S3
        run: |
          echo "Deploying website files to S3 bucket: ${{ env.BUCKET_NAME }}"
          aws s3 sync src/website/ s3://${{ env.BUCKET_NAME }}/ --delete --cache-control "max-age=3600"
          echo "Website deployment completed"

      - name: Verify Website Deployment
        run: |
          echo "Verifying website deployment..."
          sleep 10
          curl -f ${{ env.WEBSITE_URL }} || exit 1
          echo "âœ… Website is accessible at: ${{ env.WEBSITE_URL }}"

      - name: Deployment Summary
        run: |
          echo "ðŸš€ Dev Deployment Summary:"
          echo "Environment: dev"
          echo "Website URL: ${{ env.WEBSITE_URL }}"
          echo "S3 Bucket: ${{ env.BUCKET_NAME }}"
          echo "Status: âœ… Success"