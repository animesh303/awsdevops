name: Orchestrator Prod

on:
  workflow_run:
    workflows: ["Orchestrator Test"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  id-token: write
  actions: write

jobs:
  # Step 1: Python (no dependencies)
  python-prod:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      run-id: ${{ steps.find-run.outputs.run-id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Find or trigger Python Prod workflow
        uses: actions/github-script@v7
        id: find-run
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'python-prd.yml',
              head_sha: context.sha,
              per_page: 1
            });

            if (runs.data.workflow_runs.length === 0) {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'python-prd.yml',
                ref: context.ref
              });
              await new Promise(resolve => setTimeout(resolve, 5000));
              const newRuns = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'python-prd.yml',
                head_sha: context.sha,
                per_page: 1
              });
              core.setOutput('run-id', newRuns.data.workflow_runs[0].id);
            } else {
              core.setOutput('run-id', runs.data.workflow_runs[0].id);
            }

      - name: Wait for Python Prod to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.ref }}
          check-name: "Python Prod"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success

      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          name: lambda-package-prd
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.find-run.outputs.run-id }}
          path: ./lambda-package

  # Step 2: Terraform (depends on Python)
  terraform-prod:
    runs-on: ubuntu-latest
    needs: [python-prod]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Download Python artifacts from previous job
        uses: actions/download-artifact@v4
        with:
          name: lambda-package-prd
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ needs.python-prod.outputs.run-id }}
          path: ./lambda-package

      - name: Place artifacts for Terraform
        run: |
          mkdir -p ./iac/terraform
          cp ./lambda-package/lambda-package.zip ./iac/terraform/lambda_function.zip
          echo "✓ Lambda package placed for Terraform"

      - name: Find or trigger Terraform Prod workflow
        uses: actions/github-script@v7
        id: find-run
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'terraform-prd.yml',
              head_sha: context.sha,
              per_page: 1
            });

            if (runs.data.workflow_runs.length === 0) {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'terraform-prd.yml',
                ref: context.ref
              });
              await new Promise(resolve => setTimeout(resolve, 5000));
              const newRuns = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'terraform-prd.yml',
                head_sha: context.sha,
                per_page: 1
              });
              core.setOutput('run-id', newRuns.data.workflow_runs[0].id);
            } else {
              core.setOutput('run-id', runs.data.workflow_runs[0].id);
            }

      - name: Wait for Terraform Prod to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.ref }}
          check-name: "Terraform Prod"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success

  # Final: Deployment Summary
  deployment-summary:
    runs-on: ubuntu-latest
    needs: [python-prod, terraform-prod]
    if: always()
    steps:
      - name: Generate deployment summary
        run: |
          echo "## Prod Environment Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python Prod | ${{ needs.python-prod.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Prod | ${{ needs.terraform-prod.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Order**: Python → Terraform" >> $GITHUB_STEP_SUMMARY
          echo "**Dependency**: Terraform depends on Python Lambda package" >> $GITHUB_STEP_SUMMARY