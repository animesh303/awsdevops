name: Terraform Test

on:
  workflow_run:
    workflows: ["Python Test"]
    types: [completed]
    branches: [main]
  push:
    branches: [main]
    paths:
      - "iac/terraform/**"
      - ".github/workflows/terraform-test.yml"

permissions:
  contents: read
  security-events: write
  id-token: write

concurrency:
  group: deploy-terraform-${{ github.ref }}-test
  cancel-in-progress: false

jobs:
  tf-validate:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.1
      
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}
      
      - name: Configure Terraform Cloud
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          cat > $HOME/.terraformrc << EOF
          credentials "app.terraform.io" {
            token = "$TFC_TOKEN"
          }
          EOF
      
      - name: Terraform Init (backend=false)
        run: |
          cd iac/terraform
          terraform init -backend=false
      
      - name: Terraform Validate
        run: |
          cd iac/terraform
          terraform validate
      
      - name: Terraform Format
        run: |
          cd iac/terraform
          terraform fmt

  tf-plan:
    needs: [tf-validate]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.1
      
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}
      
      - name: Configure Terraform Cloud
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          cat > $HOME/.terraformrc << EOF
          credentials "app.terraform.io" {
            token = "$TFC_TOKEN"
          }
          EOF
      
      - name: Terraform Init
        run: |
          cd iac/terraform
          terraform init
      
      - name: Terraform Plan
        run: |
          cd iac/terraform
          terraform plan

  tf-security:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}
      
      - name: Run Checkov (SARIF)
        run: |
          pip install checkov
          cd iac/terraform
          checkov -d . --output-file-path results_sarif.sarif --output sarif
      
      - name: Upload SARIF artifact
        uses: actions/upload-artifact@v4
        with:
          name: checkov-sarif
          path: iac/terraform/results_sarif.sarif
          retention-days: 1

  tf-upload-sarif:
    needs: [tf-security]
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Download SARIF artifact
        uses: actions/download-artifact@v4
        with:
          name: checkov-sarif
      
      - name: Upload SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('results_sarif.sarif') != ''
        with:
          sarif_file: results_sarif.sarif
          category: checkov

  deploy-test:
    needs: [tf-validate, tf-plan, tf-security, tf-upload-sarif]
    runs-on: ubuntu-latest
    if: always() && (needs.tf-validate.result == 'success' && needs.tf-plan.result == 'success' && needs.tf-security.result != 'failure')
    environment: test
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}
      
      - name: Download Lambda package from upstream workflow
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: lambda-package-test
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ./lambda-package
      
      - name: Move Lambda package to Terraform directory
        if: github.event_name == 'workflow_run'
        run: |
          mkdir -p ./iac/terraform
          cp ./lambda-package/lambda-package.zip ./iac/terraform/lambda_function.zip
          echo "TF_VAR_lambda_package_path=$(pwd)/iac/terraform/lambda_function.zip" >> $GITHUB_ENV
      
      - name: Verify Lambda package exists
        if: github.event_name == 'workflow_run'
        run: |
          if [ ! -f "./iac/terraform/lambda_function.zip" ]; then
            echo "Error: lambda_function.zip not found at expected location!"
            exit 1
          fi
          echo "Lambda package verified at: ./iac/terraform/lambda_function.zip"
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.1
      
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}
      
      - name: Configure Terraform Cloud
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          cat > $HOME/.terraformrc << EOF
          credentials "app.terraform.io" {
            token = "$TFC_TOKEN"
          }
          EOF
      
      - name: Set Lambda package path fallback
        if: github.event_name == 'push'
        run: |
          echo "TF_VAR_lambda_package_path=src/lambda-python-s3-lambda-trigger" >> $GITHUB_ENV
      
      - name: Terraform Init
        run: |
          cd iac/terraform
          terraform init
      
      - name: Terraform Plan and Apply
        run: |
          cd iac/terraform
          terraform plan
          terraform apply -auto-approve
      
      - name: Deploy to test environment
        run: |
          echo "Terraform infrastructure deployed to test environment"