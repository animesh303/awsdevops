name: Terraform Dev

on:
  push:
    branches: [develop]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  tf-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.1
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}
      - name: Configure Terraform Cloud
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          cat > $HOME/.terraformrc << EOF
          credentials "app.terraform.io" {
            token = "$TFC_TOKEN"
          }
          EOF
      - name: Terraform Init
        run: |
          cd iac/terraform
          terraform init -backend=false
      - name: Terraform Validate
        run: |
          cd iac/terraform
          terraform validate
      - name: Terraform Format
        run: |
          cd iac/terraform
          terraform fmt

  tf-plan:
    needs: [tf-validate]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.1
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}
      - name: Configure Terraform Cloud
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          cat > $HOME/.terraformrc << EOF
          credentials "app.terraform.io" {
            token = "$TFC_TOKEN"
          }
          EOF
      - name: Detect Terraform Cloud backend
        id: detect-tfc
        run: |
          cd iac/terraform
          if grep -q "cloud" backend.tf 2>/dev/null || [ -n "$TFC_TOKEN" ]; then
            echo "USE_TFC=true" >> $GITHUB_ENV
            echo "Terraform Cloud backend detected"
          else
            echo "USE_TFC=false" >> $GITHUB_ENV
            echo "Standard backend detected"
          fi
      - name: Terraform Init
        run: |
          cd iac/terraform
          terraform init
      - name: Terraform Plan
        run: |
          cd iac/terraform
          terraform plan

  tf-security:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Run Checkov
        run: |
          pip install checkov
          checkov -d iac/terraform/ || true

  deploy-dev:
    needs: [tf-validate, tf-plan, tf-security]
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.1
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}
      - name: Configure Terraform Cloud
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          cat > $HOME/.terraformrc << EOF
          credentials "app.terraform.io" {
            token = "$TFC_TOKEN"
          }
          EOF
      - name: Terraform Init
        run: |
          cd iac/terraform
          terraform init
      - name: Terraform Apply
        run: |
          cd iac/terraform
          terraform apply -auto-approve