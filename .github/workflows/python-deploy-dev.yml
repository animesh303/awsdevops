name: Python Deploy to dev

on:
  workflow_run:
    workflows: ["Python CI"]
    types: [completed]
    branches: [develop]

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-python-${{ github.ref }}-${{ github.workflow }}-dev
  cancel-in-progress: false

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: dev
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f src/lambda-s3-lambda-trigger/requirements.txt ]; then pip install -r src/lambda-s3-lambda-trigger/requirements.txt; fi
      
      - name: Package Lambda function
        run: |
          cd src/lambda-s3-lambda-trigger
          zip -r ../../lambda-function-dev.zip .
      
      - name: Deploy Lambda function to dev
        run: |
          aws lambda update-function-code \
            --function-name s3-lambda-trigger-hello-world-dev \
            --zip-file fileb://lambda-function-dev.zip
      
      - name: Upload Lambda package to S3 (dev)
        run: |
          aws s3 cp lambda-function-dev.zip s3://${{ vars.DEPLOYMENT_BUCKET }}/lambda/dev/
      
      - name: Verify deployment
        run: |
          aws lambda get-function --function-name s3-lambda-trigger-hello-world-dev
          echo "âœ… Lambda function deployed to dev environment"