name: Terraform Deploy to prod

on:
  workflow_run:
    workflows: ["Terraform Deploy to test"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-terraform-${{ github.ref }}-${{ github.workflow }}-prod
  cancel-in-progress: false

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - name: Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
            iac/terraform/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('iac/terraform/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.1

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Configure Terraform Cloud
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          cat > $HOME/.terraformrc << EOF
          credentials "app.terraform.io" {
            token = "$TFC_TOKEN"
          }
          EOF

      - name: Terraform Init
        working-directory: iac/terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: iac/terraform
        run: terraform plan

      - name: Terraform Apply
        working-directory: iac/terraform
        run: terraform apply -input=false -auto-approve

      - name: Get Website Bucket Name
        working-directory: iac/terraform
        run: |
          echo "BUCKET_NAME=$(terraform output -raw website_bucket_name)" >> $GITHUB_ENV
          echo "WEBSITE_URL=$(terraform output -raw website_url)" >> $GITHUB_ENV

      - name: Deploy Website Files to S3
        run: |
          echo "Deploying website files to S3 bucket: ${{ env.BUCKET_NAME }}"
          aws s3 sync src/website/ s3://${{ env.BUCKET_NAME }}/ --delete --cache-control "max-age=86400"
          echo "Website deployment completed"

      - name: Run Smoke Tests
        run: |
          echo "Running smoke tests against production environment..."
          sleep 15
          
          # Critical functionality test
          curl -f ${{ env.WEBSITE_URL }} || exit 1
          echo "âœ… Production website is accessible"
          
          # Content validation
          response=$(curl -s ${{ env.WEBSITE_URL }})
          if echo "$response" | grep -q "Hello World"; then
            echo "âœ… Production content is correct"
          else
            echo "âŒ Production content validation failed"
            exit 1
          fi
          
          # Security headers check
          headers=$(curl -I -s ${{ env.WEBSITE_URL }})
          if echo "$headers" | grep -q "200 OK"; then
            echo "âœ… Production returns correct status"
          else
            echo "âŒ Production status check failed"
            exit 1
          fi

      - name: Post-Deployment Security Check
        run: |
          echo "Running post-deployment security checks..."
          
          # Check S3 bucket policy
          aws s3api get-bucket-policy --bucket ${{ env.BUCKET_NAME }} > /dev/null
          echo "âœ… S3 bucket policy is configured"
          
          # Check bucket encryption
          aws s3api get-bucket-encryption --bucket ${{ env.BUCKET_NAME }} > /dev/null
          echo "âœ… S3 bucket encryption is enabled"
          
          # Check versioning
          versioning=$(aws s3api get-bucket-versioning --bucket ${{ env.BUCKET_NAME }} --query 'Status' --output text)
          if [ "$versioning" = "Enabled" ]; then
            echo "âœ… S3 bucket versioning is enabled"
          else
            echo "âš ï¸ S3 bucket versioning check warning"
          fi

      - name: Notify Deployment Success
        run: |
          echo "ðŸŽ‰ Production Deployment Successful! ðŸŽ‰"
          echo ""
          echo "ðŸ“Š Deployment Details:"
          echo "Environment: ðŸ­ Production"
          echo "Website URL: ðŸŒ ${{ env.WEBSITE_URL }}"
          echo "S3 Bucket: ðŸª£ ${{ env.BUCKET_NAME }}"
          echo "Smoke Tests: âœ… All Passed"
          echo "Security Checks: ðŸ”’ All Passed"
          echo "Deployment Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ðŸš€ Your website is now live in production!"

      - name: Create Deployment Record
        run: |
          echo "Creating deployment record..."
          cat > deployment-record.json << EOF
          {
            "environment": "prod",
            "website_url": "${{ env.WEBSITE_URL }}",
            "bucket_name": "${{ env.BUCKET_NAME }}",
            "deployment_time": "$(date -u -Iseconds)",
            "commit_sha": "${{ github.sha }}",
            "workflow_run_id": "${{ github.run_id }}",
            "status": "success"
          }
          EOF
          echo "Deployment record created"